/*Базы данных и SQL (семинары) Урок 4
Для выполнения домашнего задания вы можете использовать SQLite Online или любую
другую среду выполнения SQL.
Используйте прикрепленные sql код scv_hw_04.zip для создания базы данных.
Задание 1: Ранжирование продуктов по средней цене
Задание: Ранжируйте продукты в каждой категории на основе их средней цены
(AvgPrice). Используйте таблицы OrderDetails и Products.
Результат: В результате запроса будут следующие столбцы:
● CategoryID: идентификатор категории продукта,
● ProductID: идентификатор продукта,
● ProductName: название продукта,
● AvgPrice: средняя цена продукта,
● ProductRank: ранг продукта внутри своей категории на основе средней цены в
порядке убывания.*/



WITH ProductAvgPrice AS (
SELECT
p.CategoryID,
p.ProductID,
p.ProductName,
AVG(p.Price) AS AvgPrice
FROM Products p
JOIN OrderDetails od ON p.ProductID = od.ProductID
GROUP BY p.CategoryID, p.ProductID, p.ProductName
)

SELECT
CategoryID,
ProductID,
ProductName,
AvgPrice,
RANK() OVER (PARTITION BY CategoryID ORDER BY AvgPrice DESC) AS ProductRank
FROM ProductAvgPrice;


/*
1	38	CÃƒÂ´te de Blaye	263.5	1
1	43	Ipoh Coffee	46.0	2
1	2	Chang	19.0	3
1	1	Chais	18.0	4
1	35	Steeleye Stout	18.0	4
1	39	Chartreuse verte	18.0	4
1	76	LakkalikÃƒÂ¶ÃƒÂ¶ri	18.0	4
1	70	Outback Lager	15.0	8
1	34	Sasquatch Ale	14.0	9
1	67	Laughing Lumberjack Lager	14.0	9
1	75	RhÃƒÂ¶nbrÃƒÂ¤u Klosterbier	7.75	11
1	24	GuaranÃƒÂ¡ FantÃƒÂ¡stica	4.5	12
2	63	Vegie-spread	43.9	1
2	8	Northwoods Cranberry Sauce	40.0	2
2	61	Sirop d'ÃƒÂ©rable	28.5	3
2	6	Grandma's Boysenberry Spread	25.0	4
2	4	Chef Anton's Cajun Seasoning	22.0	5
2	5	Chef Anton's Gumbo Mix	21.35	6
2	65	Louisiana Fiery Hot Pepper Sauce	21.05	7
2	44	Gula Malacca	19.45	8
2	66	Louisiana Hot Spiced Okra	17.0	9
2	15	Genen Shouyu	15.5	10
2	77	Original Frankfurter grÃƒÂ¼ne SoÃƒÅ¸e	13.0	11
2	3	Aniseed Syrup	10.0	12
3	20	Sir Rodney's Marmalade	81.0	1
3	62	Tarte au sucre	49.3	2
3	27	Schoggi Schokolade	43.9	3
3	26	GumbÃƒÂ¤r GummibÃƒÂ¤rchen	31.23	4
3	49	Maxilaku	20.0	5
3	16	Pavlova	17.45	6
3	50	Valkoinen suklaa	16.25	7
3	25	NuNuCa NuÃƒÅ¸-Nougat-Creme	14.0	8
3	48	Chocolade	12.75	9
3	68	Scottish Longbreads	12.5	10
3	21	Sir Rodney's Scones	10.0	11
3	47	Zaanse koeken	9.5	12
3	19	Teatime Chocolate Biscuits	9.2	13
4	59	Raclette Courdavault	55.0	1
4	12	Queso Manchego La Pastora	38.0	2
4	69	Gudbrandsdalsost	36.0	3
4	72	Mozzarella di Giovanni	34.8	4
4	60	Camembert Pierrot	34.0	5
4	32	Mascarpone Fabioli	32.0	6
4	71	FlÃƒÂ¸temysost	21.5	7
4	11	Queso Cabrales	21.0	8
4	31	Gorgonzola Telino	12.5	9
4	33	Geitost	2.5	10
5	56	Gnocchi di nonna Alice	38.0	1
5	64	Wimmers gute SemmelknÃƒÂ¶del	33.25	2
5	22	Gustaf's KnÃƒÂ¤ckebrÃƒÂ¶d	21.0	3
5	57	Ravioli Angelo	19.5	4
5	42	Singaporean Hokkien Fried Mee	14.0	5
5	23	TunnbrÃƒÂ¶d	9.0	6
5	52	Filo Mix	7.0	7
6	29	ThÃƒÂ¼ringer Rostbratwurst	123.79000000000002	1
6	9	Mishi Kobe Niku	97.0	2
6	17	Alice Mutton	39.0	3
6	53	Perth Pasties	32.8	4
6	55	PÃƒÂ¢tÃƒÂ© chinois	24.0	5
6	54	TourtiÃƒÂ¨re	7.45	6
7	51	Manjimup Dried Apples	53.0	1
7	28	RÃƒÂ¶ssle Sauerkraut	45.6	2
7	7	Uncle Bob's Organic Dried Pears	30.0	3
7	14	Tofu	23.25	4
7	74	Longlife Tofu	10.0	5
8	18	Carnarvon Tigers	62.5	1
8	10	Ikura	31.0	2
8	37	Gravad lax	26.0	3
8	30	Nord-Ost Matjeshering	25.89	4
8	36	Inlagd Sill	19.0	5
8	40	Boston Crab Meat	18.4	6
8	73	RÃƒÂ¶d Kaviar	15.0	7
8	58	Escargots de Bourgogne	13.25	8
8	46	Spegesild	12.0	9
8	41	Jack's New England Clam Chowder	9.65	10
8	45	RÃƒÂ¸gede sild	9.5	11
8	13	Konbu	6.0	12
*/


/*Задание 2: Средняя и максимальная сумма кредита по месяцам
Задание: Рассчитайте среднюю сумму кредита (AvgCreditAmount) для каждого
кластера в каждом месяце и сравните её с максимальной суммой кредита
(MaxCreditAmount) за тот же месяц. Используйте таблицу Clusters*/

WITH AvgCredit AS (
SELECT *,
month,
cluster,
AVG(credit_amount) AS AvgCreditAmount
FROM Clusters
GROUP BY month, cluster
),

MaxCredit AS (
SELECT
month,
MAX(credit_amount) AS MaxCreditAmount
FROM Clusters
GROUP BY month
)

SELECT
a.month,
a.cluster,
a.AvgCreditAmount,
m.MaxCreditAmount
FROM AvgCredit a
JOIN MaxCredit m ON a.month = m.month;
/*

1	0	18000.0	152000
1	2	39500.0	152000
1	3	22114.864864864863	152000
1	4	33714.28571428572	152000
2	0	22452.380952380954	199000
2	2	74750.0	199000
2	3	25530.303030303032	199000
2	4	31337.20930232558	199000
2	5	190500.0	199000
2	6	57166.666666666664	199000
3	0	26607.14285714286	221000
3	2	82100.0	221000
3	3	21768.817204301075	221000
3	4	37071.42857142857	221000
3	5	39000.0	221000
3	6	30166.666666666668	221000
4	0	20650.0	163000
4	2	56000.0	163000
4	3	24519.736842105263	163000
4	4	36628.205128205125	163000
4	5	15000.0	163000
4	6	64833.333333333336	163000
5	0	21976.190476190477	144000
5	2	68500.0	144000
5	3	22265.151515151516	144000
5	4	40086.95652173913	144000
5	6	20200.0	144000
6	0	36727.27272727273	166000
6	2	37750.0	166000
6	3	26812.5	166000
6	4	32607.14285714286	166000
6	6	131000.0	166000
7	0	22866.666666666668	127000
7	1	14250.0	127000
7	2	59785.71428571428	127000
7	3	19773.4375	127000
7	4	35403.846153846156	127000
7	5	71666.66666666667	127000
7	6	25750.0	127000
8	0	23764.70588235294	201000
8	1	118500.0	201000
8	2	47750.0	201000
8	3	23457.14285714286	201000
8	4	32170.731707317074	201000
8	6	42700.0	201000
9	0	32384.615384615383	116000
9	2	84833.33333333333	116000
9	3	19479.45205479452	116000
9	4	28700.0	116000
9	5	29500.0	116000
9	6	14500.0	116000
10	0	21666.666666666668	301000
10	1	14000.0	301000
10	2	86600.0	301000
10	3	20423.076923076922	301000
10	4	31839.285714285714	301000
10	5	101000.0	301000
10	6	102250.0	301000
11	0	28267.85714285714	176000
11	2	70785.71428571429	176000
11	3	24590.909090909092	176000
11	4	38576.27118644068	176000
11	5	102000.0	176000
11	6	7500.0	176000
12	0	24086.956521739132	292500
12	1	44000.0	292500
12	2	57400.0	292500
12	3	23826.38888888889	292500
12	4	45308.333333333336	292500
12	5	49000.0	292500

*/

/*Задание 3: Разница в суммах кредита по месяцам
Задание: Создайте таблицу с разницей (Difference) между суммой кредита и
предыдущей суммой кредита по месяцам для каждого кластера. Используйте таблицу
Clusters*/


WITH CreditWithPrevious AS (
SELECT
month,
cluster,
credit_amount,
LAG(credit_amount) OVER (PARTITION BY cluster ORDER BY
month) AS PreviousCreditAmount
FROM Clusters
)
-- Вычисляем разницу между текущей и предыдущей суммой кредита
SELECT
month,
cluster,
credit_amount,
PreviousCreditAmount,
COALESCE(credit_amount - PreviousCreditAmount, 0) AS Difference
FROM CreditWithPrevious;

/*
month	cluster	credit_amount	PreviousCreditAmount	Difference
1	0	30 000	[NULL]	0
1	0	8 500	30 000	-21 500
1	0	18 000	8 500	9 500
1	0	8 000	18 000	-10 000
1	0	15 500	8 000	7 500
1	0	9 000	15 500	-6 500
1	0	11 500	9 000	2 500
1	0	29 500	11 500	18 000
1	0	31 500	29 500	2 000
1	0	26 500	31 500	-5 000
1	0	20 000	26 500	-6 500
1	0	8 000	20 000	-12 000
1	0	18 000	8 000	10 000
2	0	9 500	18 000	-8 500
2	0	11 000	9 500	1 500
2	0	53 500	11 000	42 500
2	0	33 000	53 500	-20 500
2	0	12 500	33 000	-20 500
2	0	20 000	12 500	7 500
2	0	12 500	20 000	-7 500
2	0	30 000	12 500	17 500
2	0	31 500	30 000	1 500
2	0	7 500	31 500	-24 000
2	0	21 000	7 500	13 500
2	0	27 500	21 000	6 500
2	0	7 000	27 500	-20 500
2	0	15 000	7 000	8 000
2	0	15 500	15 000	500
2	0	45 000	15 500	29 500
2	0	37 500	45 000	-7 500
2	0	29 000	37 500	-8 500
2	0	12 500	29 000	-16 500
2	0	28 000	12 500	15 500
2	0	12 500	28 000	-15 500
3	0	7 000	12 500	-5 500
3	0	16 000	7 000	9 000
3	0	133 000	16 000	117 000
3	0	13 000	133 000	-120 000
3	0	34 000	13 000	21 000
3	0	25 500	34 000	-8 500
3	0	11 000	25 500	-14 500
3	0	15 000	11 000	4 000
3	0	22 000	15 000	7 000
3	0	8 000	22 000	-14 000
3	0	16 000	8 000	8 000
3	0	24 500	16 000	8 500
3	0	34 000	24 500	9 500
3	0	13 500	34 000	-20 500
4	0	23 000	13 500	9 500
4	0	41 000	23 000	18 000
4	0	15 500	41 000	-25 500
4	0	51 000	15 500	35 500
4	0	12 000	51 000	-39 000
4	0	22 000	12 000	10 000
4	0	12 000	22 000	-10 000
4	0	8 500	12 000	-3 500
4	0	12 000	8 500	3 500
4	0	9 500	12 000	-2 500
5	0	21 000	9 500	11 500
5	0	14 500	21 000	-6 500
5	0	32 000	14 500	17 500
5	0	24 000	32 000	-8 000
5	0	20 500	24 000	-3 500
5	0	34 000	20 500	13 500
5	0	13 000	34 000	-21 000
5	0	14 000	13 000	1 000
5	0	13 000	14 000	-1 000
5	0	8 000	13 000	-5 000
5	0	42 000	8 000	34 000
5	0	23 000	42 000	-19 000
5	0	15 500	23 000	-7 500
5	0	38 000	15 500	22 500
5	0	11 500	38 000	-26 500
5	0	25 000	11 500	13 500
5	0	41 500	25 000	16 500
5	0	11 000	41 500	-30 500
5	0	35 500	11 000	24 500
5	0	17 500	35 500	-18 000
5	0	7 000	17 500	-10 500
6	0	29 000	7 000	22 000
6	0	8 000	29 000	-21 000
6	0	16 000	8 000	8 000
6	0	17 500	16 000	1 500
6	0	28 500	17 500	11 000
6	0	17 000	28 500	-11 500
6	0	21 000	17 000	4 000
6	0	29 000	21 000	8 000
6	0	157 500	29 000	128 500
6	0	20 000	157 500	-137 500
6	0	60 500	20 000	40 500
7	0	57 500	60 500	-3 000
7	0	28 000	57 500	-29 500
7	0	12 500	28 000	-15 500
7	0	48 000	12 500	35 500
7	0	18 000	48 000	-30 000
7	0	14 000	18 000	-4 000
7	0	9 000	14 000	-5 000
7	0	11 500	9 000	2 500
7	0	8 500	11 500	-3 000
7	0	52 500	8 500	44 000
7	0	22 500	52 500	-30 000
7	0	23 000	22 500	500
7	0	21 000	23 000	-2 000
7	0	11 000	21 000	-10 000
7	0	6 000	11 000	-5 000
8	0	61 000	6 000	55 000
8	0	16 500	61 000	-44 500
8	0	17 000	16 500	500
8	0	50 500	17 000	33 500
8	0	14 000	50 500	-36 500
8	0	26 500	14 000	12 500
8	0	5 000	26 500	-21 500
8	0	18 500	5 000	13 500
8	0	9 500	18 500	-9 000
8	0	28 000	9 500	18 500
8	0	13 500	28 000	-14 500
8	0	30 000	13 500	16 500
8	0	11 000	30 000	-19 000
8	0	29 000	11 000	18 000
8	0	7 500	29 000	-21 500
8	0	51 500	7 500	44 000
8	0	15 000	51 500	-36 500
9	0	33 500	15 000	18 500
9	0	58 500	33 500	25 000
9	0	42 000	58 500	-16 500
9	0	14 000	42 000	-28 000
9	0	14 000	14 000	0
9	0	22 000	14 000	8 000
9	0	8 000	22 000	-14 000
9	0	111 500	8 000	103 500
9	0	41 500	111 500	-70 000
9	0	6 500	41 500	-35 000
9	0	12 000	6 500	5 500
9	0	21 500	12 000	9 500
9	0	36 000	21 500	14 500
10	0	18 000	36 000	-18 000
10	0	5 500	18 000	-12 500
10	0	22 500	5 500	17 000
10	0	16 500	22 500	-6 000
10	0	40 500	16 500	24 000
10	0	14 500	40 500	-26 000
10	0	26 500	14 500	12 000
10	0	21 500	26 500	-5 000
10	0	9 500	21 500	-12 000
10	0	16 500	9 500	7 000
10	0	23 000	16 500	6 500
10	0	47 000	23 000	24 000
10	0	13 500	47 000	-33 500
10	0	30 000	13 500	16 500
10	0	20 000	30 000	-10 000
11	0	10 500	20 000	-9 500
11	0	23 000	10 500	12 500
11	0	15 000	23 000	-8 000
11	0	28 000	15 000	13 000
11	0	28 500	28 000	500
11	0	16 000	28 500	-12 500
11	0	27 000	16 000	11 000
11	0	6 000	27 000	-21 000
11	0	44 500	6 000	38 500
11	0	12 000	44 500	-32 500
11	0	26 000	12 000	14 000
11	0	12 500	26 000	-13 500
11	0	14 000	12 500	1 500
11	0	9 500	14 000	-4 500
11	0	23 500	9 500	14 000
11	0	57 500	23 500	34 000
11	0	33 500	57 500	-24 000
11	0	5 000	33 500	-28 500
11	0	36 500	5 000	31 500
11	0	31 500	36 500	-5 000
11	0	31 500	31 500	0
11	0	41 000	31 500	9 500
11	0	15 000	41 000	-26 000
11	0	18 000	15 000	3 000
11	0	176 000	18 000	158 000
11	0	23 000	176 000	-153 000
11	0	8 500	23 000	-14 500
11	0	18 500	8 500	10 000
12	0	75 000	18 500	56 500
12	0	34 000	75 000	-41 000
12	0	73 500	34 000	39 500
12	0	15 000	73 500	-58 500
12	0	14 500	15 000	-500
12	0	15 500	14 500	1 000
12	0	28 000	15 500	12 500
12	0	7 000	28 000	-21 000
12	0	23 500	7 000	16 500
12	0	38 000	23 500	14 500
12	0	10 000	38 000	-28 000
12	0	16 000	10 000	6 000
12	0	21 000	16 000	5 000
12	0	53 000	21 000	32 000
12	0	18 000	53 000	-35 000
12	0	7 500	18 000	-10 500
12	0	29 500	7 500	22 000
12	0	11 500	29 500	-18 000
12	0	5 500	11 500	-6 000
12	0	7 500	5 500	2 000
12	0	11 000	7 500	3 500
12	0	7 500	11 000	-3 500
